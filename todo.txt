# AAISP CHAOS API Prometheus Exporter - Project TODO

## Project Status
Started: 2025-11-11
Last Updated: 2025-11-13
Current Phase: ✅ Comprehensive metrics expansion complete - All major subsystems implemented

## Session Summary

### Session 1 (2025-11-11)
- Created complete project scaffolding (31 files, ~1,900 lines of code)
- Implemented tiered collector system (FAST/MEDIUM/SLOW)
- Built CHAOS API client with async support and retry logic
- Created FastAPI app with /, /metrics, /health endpoints
- Added Docker support (multi-stage build, docker-compose)
- Set up CI/CD pipelines (GitHub Actions)
- Comprehensive README and complete metrics catalog
- Basic unit tests for configuration module
- Initial collectors: BroadbandQuotaCollector, BroadbandInfoCollector (partial)

### Session 2 (2025-11-12)
- ✅ Added aaisp_broadband_line_state metric to BroadbandInfoCollector
- ✅ Enhanced aaisp_broadband_service_info with additional labels (care_level, router_type, ipv4_address, ipv6_prefix)
- ✅ Created BroadbandUsageCollector (SLOW tier) for usage metrics
- ✅ Added API client performance metrics (aaisp_api_requests_total, aaisp_api_request_duration_seconds)
- ✅ Updated CHAOSClient to accept registry and record metrics
- ✅ Created comprehensive unit tests for all broadband collectors and API metrics
- **Result**: 20/20 Phase 1-6 metrics now implemented (100% coverage)

### Session 3 (2025-11-13)
**Major Expansion: Comprehensive Metrics & New Subsystems**

#### Broadband Enhancements
- ✅ Enhanced BroadbandInfoCollector with 18 NEW metrics:
  - **Line Quality**: SNR margin (up/down), attenuation (up/down), FEC/CRC/HEC errors
  - **Session Tracking**: uptime, start timestamp, active PPP sessions
  - **IPv6**: enabled status, prefix length extraction
  - **QoS**: latency, jitter, packet loss
- ✅ Added 7 helper parsing methods for robust data extraction
- ✅ Graceful handling of missing/optional API fields
- **Total Broadband Metrics**: 30+ metrics across 3 collectors

#### New Subsystems Implemented
- ✅ **Domain Collector** (SLOW tier - 900s):
  - Domain info, expiry monitoring, days until expiry
  - Auto-renew status tracking
  - 3 metrics with date parsing support
- ✅ **Telephony Info Collector** (MEDIUM tier - 300s):
  - Service status, call statistics (inbound/outbound)
  - Call counts, duration, costs tracking
  - Active calls monitoring
  - 5 metrics across call tracking and service info
- ✅ **Telephony Ratecard Collector** (SLOW tier - 900s):
  - Rate per minute by destination
  - Ratecard update timestamp
  - 2 metrics for rate monitoring

#### API Client Extensions
- ✅ Added `telephony_services()` and `telephony_info()` methods
- ✅ Added `domain_services()` and `domain_info()` methods
- **Total API Methods**: 10 methods across 3 subsystems

#### Configuration & Documentation
- ✅ Added collector toggles: `enable_domain`, `enable_telephony_ratecard`
- ✅ Updated .env.example, .env, docker-compose.yml with new toggles
- ✅ Comprehensive README metrics documentation (130+ lines)
- ✅ Updated collectors/__init__.py to register new modules
- **Total Collector Toggles**: 5 (broadband, telephony, telephony_ratecard, domain, control_login)

#### Metrics Summary
- **Broadband**: 30+ metrics (quota, speeds, line quality, session, IPv6, QoS, status, usage)
- **Telephony**: 7 metrics (service info, calls, duration, cost, rates)
- **Exporter**: 7 metrics (uptime, build info, collector stats, API stats)
- **TOTAL**: 44+ metrics across all subsystems

### Session 4 (2025-11-13)
**Error Handling & Domain Subsystem Removal**

#### Error Handling Improvements
- ✅ Added graceful error handling to Domain collector for "Unknown command" errors
- ✅ Added graceful error handling to Telephony collectors for HTTP 500 errors
- ✅ Added L2TP tunnel detection to Broadband collector
  - Detects L2TP tunnels from service type/technology/package fields
  - Skips physical line metrics (SNR, attenuation, errors) for L2TP
  - Still collects tunnel-level metrics (status, uptime, quota)
- ✅ Updated default configuration to disable non-working collectors
- ✅ Enhanced README with comprehensive troubleshooting documentation

#### Domain Subsystem Removal
- ✅ **Removed Domain Collector** - Domain subsystem NOT IMPLEMENTED in CHAOS API (marked "TBA")
- ✅ Deleted `src/aaisp_exporter/collectors/domains.py`
- ✅ Removed domain imports from `collectors/__init__.py`
- ✅ Removed `domain_services()` and `domain_info()` from API client
- ✅ Removed `enable_domain` configuration field
- ✅ Updated all config files (.env, .env.example, docker-compose.yml)
- ✅ Removed domain metrics documentation from README
- ✅ Removed domain troubleshooting section from README

**Rationale**: The CHAOS API documentation explicitly marks the domain subsystem as "TBA" (To Be Announced) and returns "Unknown command" errors. Rather than gracefully handle errors for an unimplemented subsystem, we removed it entirely to avoid:
- Unnecessary API calls on every collection cycle
- Confusing log warnings
- Configuration complexity for a feature that doesn't exist

**Result**: Cleaner codebase with only functional collectors. Domain support can be added in the future if/when CHAOS API implements it.

**Next Critical Step**: Test against real CHAOS API and adjust field parsing based on actual responses

## Implementation Phases

### Phase 1: Project Scaffolding ✅ COMPLETED
- [x] Project directory structure
- [x] pyproject.toml with dependencies
- [x] .pre-commit-config.yaml
- [x] Makefile for development
- [x] Dockerfile and docker-compose.yml
- [x] Basic .gitignore
- [x] README.md

### Phase 2: Core Infrastructure ✅ COMPLETED
- [x] Configuration system (core/config.py)
- [x] CHAOS API client (api/client.py)
- [x] Base collector class (collectors/base.py)
- [x] Collector registry (core/registry.py)
- [x] Collector manager (collectors/manager.py)
- [x] Logging setup (core/logging.py)
- [x] Constants and enums (core/constants.py)

### Phase 3: Broadband Collector (Primary) ✅ COMPLETED (Needs real API testing)
- [x] Broadband collector implementation (BroadbandQuotaCollector, BroadbandInfoCollector, BroadbandUsageCollector)
- [x] Service discovery (/broadband/services)
- [x] Quota metrics (/broadband/quota) - 4 metrics
- [x] Info metrics (/broadband/info) - 6 metrics including line_state
- [x] Usage metrics (/broadband/usage) - 2 metrics (EXPERIMENTAL)
- [x] Line speed metrics - 4 metrics
- [x] Service status metrics - 2 metrics
- [x] Extended service_info labels (care_level, router_type, ipv4_address, ipv6_prefix)
- [x] API client metrics (requests_total, request_duration)

**Note**: Field names (quota, sync_down, line_status, etc.) are assumptions - need validation against real API
**Warning**: Usage collector format is UNKNOWN - may need significant adjustment after API testing

### Phase 4: FastAPI Application ✅ COMPLETED
- [x] FastAPI app setup (app.py)
- [x] /metrics endpoint
- [x] /health endpoint
- [x] / landing page (HTML with status)
- [x] Lifespan management
- [x] Background collection tasks
- [x] Entry point (__main__.py)

### Phase 5: Testing & Documentation ⚠️ PARTIALLY COMPLETED
- [ ] Unit tests for API client
- [ ] Unit tests for collectors
- [ ] Test fixtures for CHAOS responses
- [ ] Integration tests
- [x] README with setup instructions
- [x] Configuration documentation
- [x] Metrics documentation
- [x] Unit tests for configuration (15 tests)

**TODO**: Expand test coverage (target: 80%+)

### Phase 6: CI/CD & Deployment ✅ COMPLETED
- [x] GitHub Actions CI workflow
- [x] Docker build workflow
- [x] Pre-commit hooks integration
- [x] Code coverage reporting (configured, needs more tests)
- [x] Security scanning (bandit)

### Phase 7: Additional Collectors ✅ MOSTLY COMPLETED
- [ ] Control login collector (basic) - Config ready, collector not yet implemented
- [x] Telephony info collector (basic) - COMPLETED (Session 3)
- [x] Telephony ratecard collector - COMPLETED (Session 3)
- [x] ~~Domain collector~~ - REMOVED (Session 4) - Subsystem not implemented in CHAOS API
- [ ] Email collector (when API available and needed)
- [ ] SIM collector (when API available and needed)

---

## Complete Metrics Catalog

### BROADBAND SUBSYSTEM METRICS

#### Quota Metrics (from /broadband/quota and /broadband/info)
- aaisp_broadband_quota_total_bytes
  * Description: Total monthly quota in bytes
  * Type: Gauge
  * Labels: service, login, account_number
  * Source: /broadband/quota command

- aaisp_broadband_quota_used_bytes
  * Description: Used quota in bytes for current month
  * Type: Gauge
  * Labels: service, login, account_number
  * Source: /broadband/quota command

- aaisp_broadband_quota_remaining_bytes
  * Description: Remaining quota in bytes for current month
  * Type: Gauge
  * Labels: service, login, account_number
  * Source: /broadband/quota command

- aaisp_broadband_quota_percentage
  * Description: Percentage of quota used
  * Type: Gauge
  * Labels: service, login, account_number
  * Calculated: (used / total) * 100

#### Line Speed Metrics (from /broadband/info)
- aaisp_broadband_line_sync_download_bps
  * Description: Line sync download speed in bits per second
  * Type: Gauge
  * Labels: service, login, line_type (ADSL/VDSL/FTTP)
  * Source: /broadband/info command

- aaisp_broadband_line_sync_upload_bps
  * Description: Line sync upload speed in bits per second
  * Type: Gauge
  * Labels: service, login, line_type
  * Source: /broadband/info command

- aaisp_broadband_throughput_download_bps
  * Description: Actual download throughput in bits per second
  * Type: Gauge
  * Labels: service, login, line_type
  * Source: /broadband/info command

- aaisp_broadband_throughput_upload_bps
  * Description: Actual upload throughput in bits per second
  * Type: Gauge
  * Labels: service, login, line_type
  * Source: /broadband/info command

#### Service Status Metrics (from /broadband/info)
- aaisp_broadband_service_up
  * Description: Service operational status (1 = up, 0 = down)
  * Type: Gauge
  * Labels: service, login, line_type
  * Source: /broadband/info command

- aaisp_broadband_line_state
  * Description: Line state (1 = in sync, 0 = out of sync)
  * Type: Gauge
  * Labels: service, login, line_type
  * Source: /broadband/info command

#### Service Info (from /broadband/info)
- aaisp_broadband_service_info
  * Description: Service information (value always 1, info in labels)
  * Type: Gauge
  * Labels: service, login, line_type, package, care_level, router_type, ipv4_address, ipv6_prefix
  * Source: /broadband/info command
  * Note: Info metric pattern - all info is in labels

#### Usage Metrics (from /broadband/usage)
- aaisp_broadband_usage_download_bytes
  * Description: Download usage in bytes (time-series data)
  * Type: Counter or Gauge depending on implementation
  * Labels: service, login, timestamp
  * Source: /broadband/usage command
  * Note: May return time-series data, need to understand format

- aaisp_broadband_usage_upload_bytes
  * Description: Upload usage in bytes (time-series data)
  * Type: Counter or Gauge
  * Labels: service, login, timestamp
  * Source: /broadband/usage command

#### Collection Performance Metrics
- aaisp_collector_duration_seconds
  * Description: Time taken to collect metrics per collector
  * Type: Histogram
  * Labels: collector_name, subsystem

- aaisp_collector_errors_total
  * Description: Total errors during collection
  * Type: Counter
  * Labels: collector_name, subsystem, error_type

- aaisp_api_requests_total
  * Description: Total API requests made
  * Type: Counter
  * Labels: subsystem, command, status_code

- aaisp_api_request_duration_seconds
  * Description: API request duration
  * Type: Histogram
  * Labels: subsystem, command

### TELEPHONY SUBSYSTEM METRICS (Future)

#### Rate Card Metrics (from /telephony/ratecard)
- aaisp_telephony_rate_info
  * Description: Telephony rate information (info in labels)
  * Type: Gauge
  * Labels: destination, rate_name, cost_per_minute
  * Source: /telephony/ratecard command

#### Call Metrics (from /telephony/usage - if available)
- aaisp_telephony_call_duration_seconds_total
  * Description: Total call duration
  * Type: Counter
  * Labels: service, direction (inbound/outbound), destination

- aaisp_telephony_call_cost_total
  * Description: Total call cost
  * Type: Counter
  * Labels: service, destination

### LOGIN SUBSYSTEM METRICS (Future)

#### Login Info (from /login/info)
- aaisp_login_info
  * Description: Control login information (info in labels)
  * Type: Gauge
  * Labels: control_login, account_number, permissions
  * Source: /login/info command

- aaisp_login_services_total
  * Description: Total number of services accessible by login
  * Type: Gauge
  * Labels: control_login, subsystem

### EXPORTER HEALTH METRICS

- aaisp_exporter_up
  * Description: Exporter is running (always 1)
  * Type: Gauge

- aaisp_exporter_build_info
  * Description: Build information
  * Type: Gauge
  * Labels: version, python_version, commit_sha

- aaisp_exporter_last_successful_collection_timestamp
  * Description: Timestamp of last successful collection
  * Type: Gauge
  * Labels: collector_name

---

## CHAOS API Endpoints Reference

### Broadband Subsystem
- GET/POST https://chaos2.aa.net.uk/broadband/services
  * Returns: List of service IDs accessible by control-login
  * Auth: control-login + control-password OR account-number + account-password

- GET/POST https://chaos2.aa.net.uk/broadband/info
  * Params: service (phone number, line ID, or circuit ID)
  * Returns: Service details, quota, line speeds, settings
  * Auth: control-login OR account-number

- GET/POST https://chaos2.aa.net.uk/broadband/quota
  * Params: service
  * Returns: Monthly quota and remaining quota
  * Auth: control-login OR account-number

- GET/POST https://chaos2.aa.net.uk/broadband/usage
  * Params: service, optional date range
  * Returns: Usage details (format TBD from testing)
  * Auth: control-login OR account-number

- GET/POST https://chaos2.aa.net.uk/broadband/kill
  * Params: service
  * Returns: Confirmation of PPP kill/restart
  * Auth: control-login OR account-number
  * Note: Operational command, may not be needed for exporter

### Login Subsystem
- GET/POST https://chaos2.aa.net.uk/login/services
  * Returns: List of control logins available
  * Auth: control-login OR account-number

- GET/POST https://chaos2.aa.net.uk/login/info
  * Params: service (control-login)
  * Returns: Login settings and attributes
  * Auth: control-login OR account-number

### Telephony Subsystem
- GET/POST https://chaos2.aa.net.uk/telephony/ratecard
  * Returns: Rate card with destinations and charges
  * Auth: control-login OR account-number

- GET/POST https://chaos2.aa.net.uk/telephony/services
  * Returns: List of telephony service IDs
  * Auth: control-login OR account-number

- GET/POST https://chaos2.aa.net.uk/telephony/info
  * Params: service
  * Returns: Telephony service details
  * Auth: control-login OR account-number

---

## Technical Notes

### Authentication Strategy
- Support both authentication methods:
  1. control-login + control-password (for service info/usage/adjust)
  2. account-number + account-password (full access including orders)
- For exporter: primarily use control-login (read-only operations)
- Store credentials in environment variables
- Support for multiple accounts/logins

### API Client Implementation
- Use httpx AsyncClient for async I/O
- Default to JSON format (append /json to URLs or use application/json POST)
- Implement retry logic with exponential backoff
- Respect rate limiting (CHAOS has rate limits to prevent abuse)
- Cache responses where appropriate (e.g., service lists)
- Handle both 200 OK and error responses with <error> objects

### Collection Strategy
- Update Tiers:
  * FAST (60s): Real-time quota usage, line status
  * MEDIUM (300s): Line speeds, throughput (align with CHAOS data blocks)
  * SLOW (900s): Service info, configuration data
- Parallel collection per service within each tier
- Bounded concurrency to respect API limits
- Graceful error handling per service (don't fail entire collection)

### Metric Labeling
- Use consistent label naming: snake_case
- Common labels across metrics:
  * service: Service identifier (phone number, line ID)
  * login: control-login associated with service
  * account_number: AA account number (if available)
  * line_type: ADSL, VDSL, FTTP
- Avoid high-cardinality labels (e.g., timestamps)

### Testing Approach
- Mock CHAOS API responses in fixtures
- Test both JSON and XML response parsing (focus on JSON)
- Test error handling (API errors, network errors, auth errors)
- Test metric generation and labeling
- Integration test with real API (optional, requires credentials)

### Dependencies (from meraki exporter inspiration)
- Python 3.13 (latest stable)
- fastapi: Web framework
- uvicorn[standard]: ASGI server
- httpx: Async HTTP client
- prometheus-client: Prometheus metrics
- pydantic: Data validation
- pydantic-settings: Configuration management
- structlog: Structured logging
- pytest: Testing framework
- ruff: Linting and formatting
- mypy: Type checking

---

## Development Workflow

### Initial Setup
```bash
# Install uv if not present
curl -LsSf https://astral.sh/uv/install.sh | sh

# Create virtual environment and install dependencies
uv sync

# Install pre-commit hooks
uv run pre-commit install

# Run exporter locally
uv run python -m aaisp_exporter
```

### Common Commands (via Makefile)
```bash
make install    # Install dependencies
make test       # Run tests
make lint       # Run linting
make format     # Format code
make type-check # Run type checking
make run        # Run exporter locally
make docker     # Build Docker image
```

### Environment Variables
```bash
AAISP_EXPORTER_CONTROL_LOGIN=your_login@a
AAISP_EXPORTER_CONTROL_PASSWORD=your_password
AAISP_EXPORTER_ACCOUNT_NUMBER=A1234A  # Optional
AAISP_EXPORTER_ACCOUNT_PASSWORD=secret # Optional
AAISP_EXPORTER_SERVER__HOST=0.0.0.0
AAISP_EXPORTER_SERVER__PORT=9099
AAISP_EXPORTER_LOG_LEVEL=INFO
```

---

## Future Enhancements

### Short Term
- [ ] Support for multiple control-logins (multi-account monitoring)
- [ ] Metric expiration management (remove stale services)
- [ ] Comprehensive error handling and logging
- [ ] Grafana dashboard examples
- [ ] Health check endpoint with collector status

### Medium Term
- [ ] OpenTelemetry integration (traces, OTLP metrics export)
- [ ] Service discovery caching with TTL
- [ ] Configurable collection intervals per subsystem
- [ ] Alerting rules examples (Prometheus)
- [ ] Historical usage data collection (if API supports)

### Long Term
- [ ] Support for ordering operations (if needed)
- [ ] Webhook support for real-time updates (if CHAOS adds)
- [ ] HA/clustering support for large deployments
- [ ] Custom metrics via configuration
- [ ] Admin UI for configuration and debugging

---

## Questions & Research Needed

1. What exact fields are returned by /broadband/info?
   - Need to test API to understand full response structure
   - Document all available attributes

2. What format does /broadband/usage return?
   - Time-series data? Aggregated? Granularity?
   - Need to determine best Prometheus metric type

3. Rate limiting details?
   - What are the actual limits?
   - How to detect rate limit errors?

4. Service ID formats?
   - Phone numbers: format validation?
   - Line IDs: always numeric?
   - Circuit IDs: format patterns?

5. XML vs JSON response differences?
   - Stick with JSON for simplicity
   - Any gotchas in JSON encoding?

6. Multi-line scenarios?
   - How to handle Office::1 with multiple lines?
   - Should each line be a separate service in metrics?

---

## Project Architecture Decisions

### ADR-001: Use JSON API Format
- Decision: Use JSON format exclusively for API requests/responses
- Rationale: Simpler parsing, native Python support, less overhead than XML
- Implementation: Append /json to URLs or use application/json content-type

### ADR-002: Tiered Collection Strategy
- Decision: Implement FAST/MEDIUM/SLOW collection tiers
- Rationale: Different data has different volatility; optimize API calls
- Tiers: FAST=60s (quota/status), MEDIUM=300s (speeds), SLOW=900s (info)

### ADR-003: Per-Service Metrics
- Decision: Metrics labeled by service ID, not aggregated
- Rationale: Prometheus aggregation is powerful; preserve granularity
- Trade-off: Higher cardinality but more flexible querying

### ADR-004: Async-First Implementation
- Decision: Use async/await throughout (httpx, FastAPI)
- Rationale: Better performance for I/O-bound operations
- Benefit: Parallel service collection without threading complexity

### ADR-005: Pydantic for Configuration
- Decision: Use pydantic-settings for configuration management
- Rationale: Type safety, validation, env var mapping, nested config
- Benefit: Self-documenting configuration with good error messages

---

## Completion Checklist

### For v0.1.0 (Initial Testing Release)
- [x] All Phase 1-4 core tasks completed
- [x] All Phase 1-6 metrics implemented (20/20 - 100% coverage)
- [x] README with complete setup instructions
- [x] Docker image buildable
- [x] CI pipeline configured
- [x] Unit tests for collectors and API client
- [ ] Tested against real CHAOS API ⚠️ CRITICAL
- [ ] Field names validated and adjusted
- [ ] At least one successful metrics collection

### For v1.0 (Production Release)
- [x] All Phase 1-6 tasks completed
- [ ] At least 80% test coverage (currently ~40% - need more tests)
- [ ] CI pipeline passing
- [ ] Docker image builds successfully (multi-arch)
- [ ] Example Grafana dashboard
- [ ] Validated against real CHAOS API with multiple services
- [ ] Security scan passing (no high/critical vulns)
- [ ] Performance tested
- [ ] Documentation complete and accurate
- [ ] Usage collector validated and adjusted based on API format

---

## Files Created/Modified

### Session 1 (2025-11-11)
**Total: 31 files, ~1,900 lines of Python code**

#### Configuration (6)
- pyproject.toml, Makefile, .pre-commit-config.yaml
- .gitignore (updated), .env.example

#### Docker (2)
- Dockerfile, docker-compose.yml

#### Source Code (15)
- Core: config.py, constants.py, logging.py, registry.py
- API: client.py
- Collectors: base.py, manager.py, broadband.py (partial)
- App: app.py, __main__.py
- Plus __init__.py files

#### Tests (3)
- conftest.py, unit/test_config.py, __init__.py

#### CI/CD (2)
- .github/workflows/ci.yml, .github/workflows/docker.yml

#### Documentation (3)
- README.md, todo.txt, .env.example

### Session 2 (2025-11-12)
**Modified: 4 files, Created: 1 file, Added: ~400 lines of code**

#### Modified Files
1. **src/aaisp_exporter/collectors/broadband.py** (~140 lines added)
   - Added line_state metric to BroadbandInfoCollector
   - Enhanced service_info with 4 additional labels
   - Created BroadbandUsageCollector (new class, ~120 lines)
   - Added defensive field extraction with fallbacks

2. **src/aaisp_exporter/api/client.py** (~60 lines added)
   - Added registry parameter to __init__
   - Created _api_requests_total Counter metric
   - Created _api_request_duration Histogram metric
   - Added _record_request_metrics() method
   - Updated request() method to record metrics in all code paths

3. **src/aaisp_exporter/app.py** (~5 lines modified)
   - Updated CHAOSClient instantiation to pass registry

4. **todo.txt** (updated session summary and phase tracking)

#### Created Files
5. **tests/unit/test_broadband_collectors.py** (new, ~200 lines)
   - Tests for BroadbandQuotaCollector
   - Tests for BroadbandInfoCollector (including new metrics)
   - Tests for BroadbandUsageCollector
   - Tests for API client metrics

---

Last Updated: 2025-11-12
Current Status: ✅ All Phase 1-6 metrics implemented (100%) - Ready for API testing
